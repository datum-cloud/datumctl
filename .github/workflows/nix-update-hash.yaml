name: "nix-update-hash"
on:
  push:
    paths:
      - 'go.mod'
      - 'go.sum'
    branches-ignore:
      - 'nix-update-hash/*'

jobs:
  update-hash:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install Task
        uses: arduino/setup-task@v2

      - name: Update Nix vendor hash
        run: task nix-update-hash

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: 'chore(nix): Update vendorHash after Go dependency changes'
          title: 'chore(nix): Update vendorHash after Go dependency changes'
          body: |
            This PR automatically updates the vendorHash in `flake.nix` after changes to Go dependencies.

            Triggered by changes to `go.mod` or `go.sum`.

            ðŸ¤– Generated by GitHub Actions
          branch: nix-update-hash/${{ github.ref_name }}
          delete-branch: true
